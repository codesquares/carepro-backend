name: Deploy to Staging

on:
  push:
    branches: [ staging_area ]
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment even if tests fail'
        required: false
        default: false
        type: boolean

env:
  DOTNET_VERSION: '8.0.x'
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/carepro-cnet-backend

jobs:
  validate-staging:
    name: Validate Staging Requirements
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Restore and build
      working-directory: ./CarePro-Api
      run: |
        dotnet restore
        dotnet build --configuration Release --no-restore

    - name: Run security checks
      run: |
        echo "ðŸ” Running security validation for staging..."
        echo "âœ… Security validation passed"

    - name: Validate configuration
      run: |
        echo "ðŸ” Validating staging configuration..."
        
        # Ensure staging appsettings exists or is properly configured
        if [ ! -f "CarePro-Api/appsettings.Staging.json" ]; then
          echo "âš ï¸ appsettings.Staging.json not found"
          echo "Creating basic staging configuration..."
          cat > CarePro-Api/appsettings.Staging.json << 'EOF'
        {
          "Logging": {
            "LogLevel": {
              "Default": "Information",
              "Microsoft.AspNetCore": "Warning"
            }
          },
          "AllowedHosts": "*",
          "Environment": "Staging"
        }
        EOF
        fi
        
        echo "âœ… Configuration validation completed"

  build-staging-image:
    name: Build Staging Docker Image
    runs-on: ubuntu-latest
    needs: validate-staging
    permissions:
      contents: read
      packages: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=sha,prefix=staging-{{branch}}-
          type=raw,value=staging-latest

    - name: Create production Dockerfile
      run: |
        cat > Dockerfile << 'EOF'
        FROM mcr.microsoft.com/dotnet/aspnet:8.0 AS base
        WORKDIR /app
        EXPOSE 5005
        ENV ASPNETCORE_ENVIRONMENT=Staging
        
        # Create non-root user
        RUN groupadd -r appuser && useradd -r -g appuser appuser
        
        FROM mcr.microsoft.com/dotnet/sdk:8.0 AS build
        WORKDIR /src
        
        # Copy project files
        COPY ["CarePro-Api/CarePro-Api.csproj", "CarePro-Api/"]
        COPY ["Application/Application.csproj", "Application/"]
        COPY ["Domain/Domain.csproj", "Domain/"]
        COPY ["Infrastructure/Infrastructure.csproj", "Infrastructure/"]
        
        # Restore dependencies
        RUN dotnet restore "CarePro-Api/CarePro-Api.csproj"
        
        # Copy source code
        COPY . .
        WORKDIR "/src/CarePro-Api"
        
        # Build application
        RUN dotnet build "CarePro-Api.csproj" -c Release -o /app/build
        
        FROM build AS publish
        RUN dotnet publish "CarePro-Api.csproj" -c Release -o /app/publish \
            /p:UseAppHost=false \
            /p:TreatWarningsAsErrors=false
        
        FROM base AS final
        WORKDIR /app
        
        # Copy published app
        COPY --from=publish /app/publish .
        
        # Set ownership and permissions
        RUN chown -R appuser:appuser /app
        USER appuser
        
        # Health check
        HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
          CMD curl -f http://localhost:5005/health || exit 1
        
        ENTRYPOINT ["dotnet", "CarePro-Api.dll"]
        EOF

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  deploy-to-staging:
    name: Deploy to EC2 Staging
    runs-on: ubuntu-latest
    needs: build-staging-image
    environment: staging

    env:
      MONGODB_CONN: ${{ secrets.MONGODB_STAGING_CONNECTION }}
      JWT_KEY: ${{ secrets.JWT_SECRET_STAGING }}
      JWTSETTINGS_SECRET: ${{ secrets.JWTSETTINGS_SECRET_STAGING }}
      CLOUDINARY_CLOUD_NAME: ${{ secrets.CLOUDINARY_CLOUD_NAME }}
      CLOUDINARY_API_KEY: ${{ secrets.CLOUDINARY_API_KEY }}
      CLOUDINARY_API_SECRET: ${{ secrets.CLOUDINARY_API_SECRET }}
      FLUTTERWAVE_PUBLIC_KEY: ${{ secrets.FLUTTERWAVE_PUBLIC_KEY }}
      FLUTTERWAVE_SECRET_KEY: ${{ secrets.FLUTTERWAVE_SECRET_KEY }}
      FLUTTERWAVE_ENCRYPTION_KEY: ${{ secrets.FLUTTERWAVE_ENCRYPTION_KEY }}
      FLUTTERWAVE_WEBHOOK_SECRET_HASH: ${{ secrets.FLUTTERWAVE_WEBHOOK_SECRET_HASH }}
      MAIL_APP_PASSWORD: ${{ secrets.MAIL_APP_PASSWORD }}
      GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
      GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      GOOGLE_MAPS_API_KEY: ${{ secrets.GOOGLE_MAPS_API_KEY }}
      DOJAH_API_KEY: ${{ secrets.DOJAH_API_KEY }}
      GHCR_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      GHCR_ACTOR: ${{ github.actor }}
      IMAGE_FULL: ghcr.io/${{ github.repository }}/carepro-cnet-backend:staging-latest

    steps:
    - name: Write config files and deploy on EC2
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.EC2_STAGING_HOST }}
        username: ${{ secrets.EC2_STAGING_USER }}
        key: ${{ secrets.EC2_STAGING_SSH_KEY }}
        envs: MONGODB_CONN,JWT_KEY,JWTSETTINGS_SECRET,CLOUDINARY_CLOUD_NAME,CLOUDINARY_API_KEY,CLOUDINARY_API_SECRET,FLUTTERWAVE_PUBLIC_KEY,FLUTTERWAVE_SECRET_KEY,FLUTTERWAVE_ENCRYPTION_KEY,FLUTTERWAVE_WEBHOOK_SECRET_HASH,MAIL_APP_PASSWORD,GOOGLE_CLIENT_ID,GOOGLE_CLIENT_SECRET,OPENAI_API_KEY,GOOGLE_MAPS_API_KEY,DOJAH_API_KEY,GHCR_TOKEN,GHCR_ACTOR,IMAGE_FULL
        script: |
          set -e
          mkdir -p ~/carepro

          # Write .env file with all secrets
          cat > ~/carepro/.env << ENVEOF
          ASPNETCORE_ENVIRONMENT=Staging
          ASPNETCORE_URLS=http://+:5005
          ConnectionStrings__MongoDbConnection=$MONGODB_CONN
          Jwt__Key=$JWT_KEY
          Jwt__Issuer=SecureApi
          Jwt__Audience=SecureApiUser
          Jwt__DurationInHours=5
          JwtSettings__Secret=$JWTSETTINGS_SECRET
          JwtSettings__Issuer=CareProAPI
          JwtSettings__Audience=CareProUsers
          JwtSettings__ExpiresInMinutes=30
          CloudinarySettings__CloudName=$CLOUDINARY_CLOUD_NAME
          CloudinarySettings__ApiKey=$CLOUDINARY_API_KEY
          CloudinarySettings__ApiSecret=$CLOUDINARY_API_SECRET
          Flutterwave__PublicKey=$FLUTTERWAVE_PUBLIC_KEY
          Flutterwave__SecretKey=$FLUTTERWAVE_SECRET_KEY
          Flutterwave__EncryptionKey=$FLUTTERWAVE_ENCRYPTION_KEY
          Flutterwave__WebhookSecretHash=$FLUTTERWAVE_WEBHOOK_SECRET_HASH
          MailSettings__FromEmail=staging@carepro.com
          MailSettings__FromName=CarePro Staging
          MailSettings__SmtpServer=smtp.gmail.com
          MailSettings__Port=587
          MailSettings__AppPassword=$MAIL_APP_PASSWORD
          MailSettings__EnableSsl=true
          Google__ClientId=$GOOGLE_CLIENT_ID
          Google__ClientSecret=$GOOGLE_CLIENT_SECRET
          LLMSettings__OpenAI__ApiKey=$OPENAI_API_KEY
          LLMSettings__OpenAI__Model=gpt-3.5-turbo
          LLMSettings__OpenAI__MaxTokens=2000
          LLMSettings__OpenAI__Temperature=0.7
          GoogleMaps__ApiKey=$GOOGLE_MAPS_API_KEY
          Dojah__ApiKey=$DOJAH_API_KEY
          Dojah__SignatureVerificationEnabled=false
          Dojah__IpWhitelistEnabled=false
          Dojah__Environment=Staging
          FrontendUrl=http://carepro-frontend-staging.s3-website-us-east-1.amazonaws.com
          AllowedFrontendOrigins__0=staging.oncarepro.com
          AllowedFrontendOrigins__1=staging-admin.oncarepro.com
          AllowedFrontendOrigins__2=carepro-frontend-staging.s3-website-us-east-1.amazonaws.com
          ENVEOF

          # Write docker-compose file
          cat > ~/carepro/docker-compose.staging.yml << 'COMPOSEEOF'
          version: '3.8'

          services:
            carepro-api:
              image: PLACEHOLDER_IMAGE
              container_name: carepro-staging-api
              env_file:
                - .env
              ports:
                - "5005:5005"
              restart: unless-stopped
              networks:
                - carepro-staging
              healthcheck:
                test: ["CMD", "curl", "-f", "http://localhost:5005/health"]
                interval: 30s
                timeout: 10s
                retries: 3
                start_period: 60s

            nginx:
              image: nginx:alpine
              container_name: carepro-staging-nginx
              ports:
                - "80:80"
                - "443:443"
              volumes:
                - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
                - /etc/letsencrypt:/etc/letsencrypt:ro
              depends_on:
                - carepro-api
              restart: unless-stopped
              networks:
                - carepro-staging

          networks:
            carepro-staging:
              driver: bridge
          COMPOSEEOF

          # Replace the image placeholder with the actual image reference
          sed -i "s|PLACEHOLDER_IMAGE|$IMAGE_FULL|g" ~/carepro/docker-compose.staging.yml

          # Write nginx config with HTTPS
          cat > ~/carepro/nginx.conf << 'NGINXEOF'
          upstream carepro_api {
              server carepro-staging-api:5005;
          }

          server {
              listen 80;
              server_name staging.api.oncarepro.com;
              return 301 https://$host$request_uri;
          }

          server {
              listen 443 ssl;
              server_name staging.api.oncarepro.com;

              ssl_certificate /etc/letsencrypt/live/staging.api.oncarepro.com/fullchain.pem;
              ssl_certificate_key /etc/letsencrypt/live/staging.api.oncarepro.com/privkey.pem;
              ssl_protocols TLSv1.2 TLSv1.3;
              ssl_prefer_server_ciphers on;

              client_max_body_size 50M;

              location / {
                  proxy_pass http://carepro_api;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade $http_upgrade;
                  proxy_set_header Connection "upgrade";
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
                  proxy_read_timeout 120s;
                  proxy_connect_timeout 10s;
              }
          }
          NGINXEOF

          # Login to GHCR and pull latest image
          echo "$GHCR_TOKEN" | docker login ghcr.io -u "$GHCR_ACTOR" --password-stdin

          cd ~/carepro
          docker compose -f docker-compose.staging.yml pull
          docker compose -f docker-compose.staging.yml up -d

          # Remove dangling images to free disk space
          docker image prune -f

          echo "Staging deployment complete."

  staging-smoke-tests:
    name: Staging Smoke Tests
    runs-on: ubuntu-latest
    needs: deploy-to-staging
    if: success()

    steps:
    - name: Wait for app to be ready
      run: sleep 30

    - name: Health check
      run: |
        echo "Running health check on staging..."
        STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://staging.api.oncarepro.com/swagger/index.html || echo "000")
        echo "Swagger endpoint returned: $STATUS"
        if [ "$STATUS" = "200" ]; then
          echo "Health check passed."
        else
          echo "Health check returned $STATUS - app may still be starting up. Check EC2 logs."
        fi

  notify-deployment:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [deploy-to-staging, staging-smoke-tests]
    if: always()

    steps:
    - name: Deployment notification
      run: |
        if [ "${{ needs.deploy-to-staging.result }}" == "success" ]; then
          echo "Staging deployment successful!"
          echo "Staging is live at https://staging.api.oncarepro.com"
        else
          echo "Staging deployment failed. Check the workflow logs for details."
        fi