name: Branch Protection & Merge Validation

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: [ main, staging ]

env:
  DOTNET_VERSION: '8.0.x'

jobs:
  pr-validation:
    name: Pull Request Validation
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Validate PR title and description
      run: |
        echo "üîç Validating Pull Request..."
        
        PR_TITLE="${{ github.event.pull_request.title }}"
        PR_BODY="${{ github.event.pull_request.body }}"
        
        # Check PR title format (conventional commits)
        if ! echo "$PR_TITLE" | grep -E "^(feat|fix|docs|style|refactor|perf|test|chore)(\(.+\))?: .+"; then
          echo "‚ùå PR title should follow conventional commit format:"
          echo "   Examples:"
          echo "   - feat(contracts): add smart contract generation"
          echo "   - fix(api): resolve authentication issue"
          echo "   - docs: update API documentation"
          echo "   - refactor(services): improve error handling"
          exit 1
        fi
        
        # Check PR description
        if [ -z "$PR_BODY" ] || [ ${#PR_BODY} -lt 50 ]; then
          echo "‚ùå PR description is too short or missing"
          echo "Please provide a detailed description including:"
          echo "- What changes were made"
          echo "- Why the changes were needed"
          echo "- How to test the changes"
          exit 1
        fi
        
        echo "‚úÖ PR title and description validation passed"

    - name: Check branch naming convention
      run: |
        BRANCH_NAME="${{ github.head_ref }}"
        echo "Validating branch name: $BRANCH_NAME"
        
        if ! echo "$BRANCH_NAME" | grep -E "^(feature|bugfix|hotfix|release)\/[a-zA-Z0-9-_]+$"; then
          echo "‚ùå Branch name should follow the pattern:"
          echo "   feature/description"
          echo "   bugfix/description"
          echo "   hotfix/description"
          echo "   release/version"
          echo ""
          echo "   Examples:"
          echo "   - feature/smart-contract-generation"
          echo "   - bugfix/authentication-fix"
          echo "   - hotfix/security-patch"
          exit 1
        fi
        
        echo "‚úÖ Branch naming convention followed"

    - name: Restore and build
      run: |
        dotnet restore
        dotnet build --configuration Release --no-restore

    - name: Check for breaking changes
      run: |
        echo "üîç Checking for potential breaking changes..."
        
        # Get the target branch for comparison
        TARGET_BRANCH="${{ github.event.pull_request.base.ref }}"
        git fetch origin $TARGET_BRANCH
        
        # Check for removed public methods/classes
        if git diff origin/$TARGET_BRANCH...HEAD --name-only | grep -E "\.(cs)$" | xargs -I {} sh -c '
          if git show origin/${{ github.event.pull_request.base.ref }}:{} 2>/dev/null | grep -q "public.*class\|public.*interface\|public.*method"; then
            if ! git show HEAD:{} 2>/dev/null | grep -q "$(git show origin/${{ github.event.pull_request.base.ref }}:{} | grep -o "public.*class\|public.*interface\|public.*method" | head -1)"; then
              echo "‚ö†Ô∏è Potential breaking change detected in {}"
            fi
          fi
        '; then
          echo "‚ö†Ô∏è Potential breaking changes detected. Please review carefully."
        else
          echo "‚úÖ No obvious breaking changes detected"
        fi

    - name: Check file changes scope
      run: |
        echo "üìÅ Analyzing changed files..."
        
        CHANGED_FILES=$(git diff --name-only origin/${{ github.event.pull_request.base.ref }}...HEAD)
        TOTAL_CHANGES=$(echo "$CHANGED_FILES" | wc -l)
        
        echo "Files changed: $TOTAL_CHANGES"
        
        if [ "$TOTAL_CHANGES" -gt 50 ]; then
          echo "‚ö†Ô∏è Large number of files changed ($TOTAL_CHANGES)"
          echo "Consider splitting this PR into smaller, focused changes"
        fi
        
        # Check if changes are focused on a specific area
        if echo "$CHANGED_FILES" | grep -q "Domain/" && \
           echo "$CHANGED_FILES" | grep -q "Infrastructure/" && \
           echo "$CHANGED_FILES" | grep -q "Application/" && \
           echo "$CHANGED_FILES" | grep -q "CarePro-Api/"; then
          echo "‚ö†Ô∏è Changes span all architecture layers"
          echo "Consider if this could be split into smaller PRs"
        fi
        
        echo "$CHANGED_FILES"

  security-check:
    name: Security Check for PR
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check for sensitive data in PR
      run: |
        echo "üîí Checking for sensitive data in PR changes..."
        
        # Get changed files
        git fetch origin ${{ github.event.pull_request.base.ref }}
        CHANGED_FILES=$(git diff --name-only origin/${{ github.event.pull_request.base.ref }}...HEAD)
        
        SECURITY_ISSUES=false
        
        # Check each changed file for sensitive patterns
        for file in $CHANGED_FILES; do
          if [ -f "$file" ] && [[ "$file" == *.cs || "$file" == *.json ]]; then
            # Check for potential secrets in the diff
            if git diff origin/${{ github.event.pull_request.base.ref }}...HEAD -- "$file" | \
               grep -E "^\+.*[\"']([a-zA-Z0-9]{20,}|sk-[a-zA-Z0-9]{20,}|pk_[a-zA-Z0-9]{20,})[\"']"; then
              echo "‚ùå Potential secret added in $file"
              SECURITY_ISSUES=true
            fi
            
            # Check for hardcoded URLs with credentials
            if git diff origin/${{ github.event.pull_request.base.ref }}...HEAD -- "$file" | \
               grep -E "^\+.*https?://[^:]+:[^@]+@"; then
              echo "‚ùå Potential credentials in URL in $file"
              SECURITY_ISSUES=true
            fi
          fi
        done
        
        if [ "$SECURITY_ISSUES" = true ]; then
          echo ""
          echo "‚ùå Security issues detected in PR!"
          echo "Please remove any hardcoded secrets or credentials."
          exit 1
        else
          echo "‚úÖ No sensitive data detected in PR changes"
        fi

    - name: Check configuration changes
      run: |
        echo "‚öôÔ∏è Checking configuration changes..."
        
        git fetch origin ${{ github.event.pull_request.base.ref }}
        
        if git diff --name-only origin/${{ github.event.pull_request.base.ref }}...HEAD | grep -q "appsettings"; then
          echo "üìù Configuration files changed - manual review required"
          
          # Show what changed in config files
          git diff origin/${{ github.event.pull_request.base.ref }}...HEAD -- "**/*appsettings*.json"
          
          echo ""
          echo "‚ö†Ô∏è Please ensure:"
          echo "1. No secrets are hardcoded"
          echo "2. Environment-specific settings are appropriate"
          echo "3. Required environment variables are documented"
        else
          echo "‚úÖ No configuration file changes"
        fi

  code-review-checklist:
    name: Code Review Checklist
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    steps:
    - name: Generate code review checklist
      run: |
        echo "# üìã Code Review Checklist" > review-checklist.md
        echo "" >> review-checklist.md
        echo "**PR:** #${{ github.event.pull_request.number }}" >> review-checklist.md
        echo "**Author:** @${{ github.event.pull_request.user.login }}" >> review-checklist.md
        echo "**Branch:** ${{ github.head_ref }} ‚Üí ${{ github.event.pull_request.base.ref }}" >> review-checklist.md
        echo "" >> review-checklist.md
        
        echo "## üîç Code Quality" >> review-checklist.md
        echo "- [ ] Code follows established patterns and conventions" >> review-checklist.md
        echo "- [ ] No code duplication or copy-paste programming" >> review-checklist.md
        echo "- [ ] Appropriate error handling and logging" >> review-checklist.md
        echo "- [ ] No debugging code or console outputs left behind" >> review-checklist.md
        echo "- [ ] Performance considerations addressed" >> review-checklist.md
        echo "" >> review-checklist.md
        
        echo "## üèóÔ∏è Architecture" >> review-checklist.md
        echo "- [ ] Changes follow Clean Architecture principles" >> review-checklist.md
        echo "- [ ] Dependency injection properly implemented" >> review-checklist.md
        echo "- [ ] No circular dependencies introduced" >> review-checklist.md
        echo "- [ ] Interfaces and abstractions used appropriately" >> review-checklist.md
        echo "" >> review-checklist.md
        
        echo "## üîí Security" >> review-checklist.md
        echo "- [ ] No hardcoded secrets or credentials" >> review-checklist.md
        echo "- [ ] Input validation and sanitization implemented" >> review-checklist.md
        echo "- [ ] Authentication and authorization properly handled" >> review-checklist.md
        echo "- [ ] SQL injection and other vulnerabilities prevented" >> review-checklist.md
        echo "" >> review-checklist.md
        
        echo "## üß™ Testing" >> review-checklist.md
        echo "- [ ] Unit tests added for new functionality" >> review-checklist.md
        echo "- [ ] Existing tests updated if needed" >> review-checklist.md
        echo "- [ ] Edge cases and error scenarios covered" >> review-checklist.md
        echo "- [ ] Integration tests considered for complex features" >> review-checklist.md
        echo "" >> review-checklist.md
        
        echo "## üìö Documentation" >> review-checklist.md
        echo "- [ ] Public APIs documented with XML comments" >> review-checklist.md
        echo "- [ ] README updated if needed" >> review-checklist.md
        echo "- [ ] Configuration changes documented" >> review-checklist.md
        echo "- [ ] Database schema changes documented" >> review-checklist.md
        echo "" >> review-checklist.md
        
        echo "## üöÄ Deployment" >> review-checklist.md
        echo "- [ ] Environment variables documented" >> review-checklist.md
        echo "- [ ] Database migrations included if needed" >> review-checklist.md
        echo "- [ ] Backward compatibility maintained" >> review-checklist.md
        echo "- [ ] Feature flags considered for large changes" >> review-checklist.md
        echo "" >> review-checklist.md
        
        echo "## üéØ Smart Contract Feature Specific" >> review-checklist.md
        echo "- [ ] Contract generation logic is correct" >> review-checklist.md
        echo "- [ ] Payment webhook integration secure" >> review-checklist.md
        echo "- [ ] Email notifications working" >> review-checklist.md
        echo "- [ ] Location services integration tested" >> review-checklist.md
        echo "- [ ] Error handling for external API failures" >> review-checklist.md
        echo "" >> review-checklist.md
        
        cat review-checklist.md

    - name: Comment checklist on PR
      if: github.event.action == 'opened'
      run: |
        echo "üìã Code review checklist generated"
        echo "This would be posted as a comment on the PR in a real environment"
        echo "Consider using GitHub CLI or API to post this automatically"

  merge-requirements:
    name: Merge Requirements Check
    runs-on: ubuntu-latest
    needs: [pr-validation, security-check]
    if: github.event.pull_request.draft == false
    
    steps:
    - name: Check merge requirements
      run: |
        echo "‚úÖ Merge Requirements Status"
        echo "============================"
        echo ""
        
        # Check if targeting the right branch
        TARGET_BRANCH="${{ github.event.pull_request.base.ref }}"
        SOURCE_BRANCH="${{ github.head_ref }}"
        
        echo "Source: $SOURCE_BRANCH"
        echo "Target: $TARGET_BRANCH"
        echo ""
        
        # Validate merge direction
        if [[ "$SOURCE_BRANCH" == feature/* ]] && [[ "$TARGET_BRANCH" != "staging" ]]; then
          echo "‚ö†Ô∏è Feature branches should typically merge to 'staging' first"
        fi
        
        if [[ "$SOURCE_BRANCH" == hotfix/* ]] && [[ "$TARGET_BRANCH" != "main" ]]; then
          echo "‚ö†Ô∏è Hotfix branches should merge directly to 'main'"
        fi
        
        echo "Requirements for merging to $TARGET_BRANCH:"
        echo ""
        
        if [ "$TARGET_BRANCH" = "main" ]; then
          echo "üìã Production (main) Requirements:"
          echo "  ‚úÖ PR validation passed"
          echo "  ‚úÖ Security check passed"
          echo "  ‚è≥ Requires 2 approving reviews"
          echo "  ‚è≥ All status checks must pass"
          echo "  ‚è≥ No merge commits (squash or rebase)"
          echo "  ‚è≥ Must be tested in staging first"
        elif [ "$TARGET_BRANCH" = "staging" ]; then
          echo "üìã Staging Requirements:"
          echo "  ‚úÖ PR validation passed"
          echo "  ‚úÖ Security check passed"
          echo "  ‚è≥ Requires 1 approving review"
          echo "  ‚è≥ All status checks must pass"
        fi
        
        echo ""
        echo "üéØ Ready for review!"

  auto-assign-reviewers:
    name: Auto-assign Reviewers
    runs-on: ubuntu-latest
    if: github.event.action == 'opened'
    
    steps:
    - name: Determine reviewers based on changes
      run: |
        echo "üë• Determining appropriate reviewers..."
        
        # This would integrate with GitHub API to auto-assign reviewers
        # based on the files changed and team structure
        
        SOURCE_BRANCH="${{ github.head_ref }}"
        CHANGED_FILES="${{ github.event.pull_request.changed_files }}"
        
        echo "Suggested reviewers based on changes:"
        
        if [[ "$SOURCE_BRANCH" == feature/* ]]; then
          echo "- Tech lead (for architecture review)"
          echo "- Senior developer (for code quality)"
        fi
        
        if [ "$CHANGED_FILES" -gt 20 ]; then
          echo "- Additional reviewer (large changes)"
        fi
        
        echo "- Product owner (for feature validation)"
        
        echo ""
        echo "üí° In a real environment, this would:"
        echo "1. Auto-assign reviewers via GitHub API"
        echo "2. Send notifications to relevant team members"
        echo "3. Add appropriate labels to the PR"