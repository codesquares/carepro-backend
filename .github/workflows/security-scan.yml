name: Security Scan

on:
  schedule:
    - cron: '0 2 * * 0'  # Weekly on Sunday at 2 AM
  workflow_dispatch:
  push:
    branches: [ main, staging ]
    paths:
      - '**/*.cs'
      - '**/*.csproj'
      - 'CarePro-Api/appsettings*.json'

env:
  DOTNET_VERSION: '8.0.x'

jobs:
  dependency-security-scan:
    name: Dependency Security Scan
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Restore packages
      run: dotnet restore

    - name: Check for vulnerable packages
      run: |
        echo "ðŸ” Scanning for vulnerable NuGet packages..."
        
        # Check each project for vulnerabilities
        VULNERABILITY_FOUND=false
        
        for project in $(find . -name "*.csproj" -not -path "./bin/*" -not -path "./obj/*"); do
          echo "Checking $project..."
          if dotnet list "$project" package --vulnerable --include-transitive 2>&1 | grep -q "has the following vulnerable packages"; then
            echo "âŒ Vulnerabilities found in $project"
            dotnet list "$project" package --vulnerable --include-transitive
            VULNERABILITY_FOUND=true
          fi
        done
        
        if [ "$VULNERABILITY_FOUND" = true ]; then
          echo "âŒ Security vulnerabilities detected in dependencies!"
          echo "Please update the vulnerable packages."
          exit 1
        else
          echo "âœ… No vulnerable packages found"
        fi

    - name: Check for outdated packages
      run: |
        echo "ðŸ” Checking for outdated packages..."
        
        # Install dotnet-outdated tool
        dotnet tool install --global dotnet-outdated-tool
        
        # Check for outdated packages
        dotnet outdated --output json > outdated-report.json || true
        
        if [ -s outdated-report.json ]; then
          echo "ðŸ“Š Outdated packages report generated"
          cat outdated-report.json
        else
          echo "âœ… All packages are up to date"
        fi

    - name: Upload dependency report
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: dependency-security-report
        path: |
          outdated-report.json
        retention-days: 30

  code-security-analysis:
    name: Static Code Security Analysis
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Install security analysis tools
      run: |
        # Install security analyzer
        dotnet tool install --global security-scan
        
        # Install additional analyzers via NuGet (add to project if needed)
        echo "Security analysis tools installed"

    - name: Scan for hardcoded secrets
      run: |
        echo "ðŸ” Scanning for hardcoded secrets and credentials..."
        
        SECRET_PATTERNS=(
          # API Keys
          '[aA][pP][iI]_?[kK][eE][yY].*[:=]\s*["\'"'"'][0-9a-zA-Z]{32,}["\'"'"']'
          # Passwords
          '[pP][aA][sS][sS][wW][oO][rR][dD].*[:=]\s*["\'"'"'][^"]{8,}["\'"'"']'
          # JWT Secrets
          '[jJ][wW][tT].*[sS][eE][cC][rR][eE][tT].*[:=]\s*["\'"'"'][^"]{32,}["\'"'"']'
          # Database Connection Strings with credentials
          'mongodb://[^:]+:[^@]+@[^"]*'
          'Server=.*User.*Password=.*'
          # OAuth secrets
          '[cC][lL][iI][eE][nN][tT]_?[sS][eE][cC][rR][eE][tT].*[:=]\s*["\'"'"'][0-9a-zA-Z]{20,}["\'"'"']'
          # Private keys
          '-----BEGIN [A-Z ]*PRIVATE KEY-----'
        )
        
        SECRETS_FOUND=false
        
        for pattern in "${SECRET_PATTERNS[@]}"; do
          if grep -r -E "$pattern" --include="*.cs" --include="*.json" --exclude-dir=bin --exclude-dir=obj .; then
            echo "âŒ Potential secret pattern found: $pattern"
            SECRETS_FOUND=true
          fi
        done
        
        # Additional checks for common secret indicators
        if grep -r -i --include="*.cs" --include="*.json" --exclude-dir=bin --exclude-dir=obj \
          -E "(sk-|pk_|secret|token|password|apikey).*[\"'][a-zA-Z0-9]{20,}[\"']" . | \
          grep -v "Password { get; set; }" | \
          grep -v "_configuration\[" | \
          grep -v "IConfiguration" | \
          grep -v "GetSection" | \
          grep -v "string.*=.*null" | \
          grep -v "string.*=.*\"\""; then
          echo "âŒ Potential hardcoded credentials found!"
          SECRETS_FOUND=true
        fi
        
        if [ "$SECRETS_FOUND" = true ]; then
          echo ""
          echo "âŒ SECURITY ALERT: Potential secrets detected in code!"
          echo "Please review the findings above and ensure:"
          echo "1. No real secrets are committed to the repository"
          echo "2. Use environment variables or secure configuration"
          echo "3. Use user secrets for development"
          echo "4. Add secrets to .gitignore if needed"
          exit 1
        else
          echo "âœ… No hardcoded secrets detected"
        fi

    - name: Check for insecure configurations
      run: |
        echo "ðŸ” Checking for insecure configurations..."
        
        SECURITY_ISSUES=false
        
        # Check for disabled HTTPS
        if grep -r -i --include="*.cs" --include="*.json" --exclude-dir=bin --exclude-dir=obj \
          "UseHttpsRedirection.*false\|RequireHttpsMetadata.*false\|http://.*prod" .; then
          echo "âŒ Insecure HTTP configuration found!"
          SECURITY_ISSUES=true
        fi
        
        # Check for disabled authentication
        if grep -r -i --include="*.cs" --exclude-dir=bin --exclude-dir=obj \
          "AllowAnonymous.*Controller\|Authorize.*false" .; then
          echo "âš ï¸  Anonymous access found - verify this is intentional"
        fi
        
        # Check for weak JWT configurations
        if grep -r -i --include="*.cs" --include="*.json" --exclude-dir=bin --exclude-dir=obj \
          "ValidateIssuer.*false\|ValidateAudience.*false\|ValidateLifetime.*false" .; then
          echo "âŒ Weak JWT validation configuration found!"
          SECURITY_ISSUES=true
        fi
        
        # Check for CORS misconfigurations
        if grep -r -i --include="*.cs" --exclude-dir=bin --exclude-dir=obj \
          "AllowAnyOrigin\|AllowAnyHeader\|AllowAnyMethod" .; then
          echo "âš ï¸  Permissive CORS configuration found - verify this is safe for production"
        fi
        
        if [ "$SECURITY_ISSUES" = true ]; then
          echo "âŒ Security configuration issues found!"
          exit 1
        else
          echo "âœ… Security configuration checks passed"
        fi

    - name: Check for dangerous code patterns
      run: |
        echo "ðŸ” Scanning for dangerous code patterns..."
        
        DANGEROUS_PATTERNS=false
        
        # SQL Injection patterns
        if grep -r -i --include="*.cs" --exclude-dir=bin --exclude-dir=obj \
          "string.*sql.*\+\|string.*query.*\+.*request\|ExecuteRaw.*\+" .; then
          echo "âŒ Potential SQL injection vulnerability found!"
          DANGEROUS_PATTERNS=true
        fi
        
        # Command injection patterns
        if grep -r -i --include="*.cs" --exclude-dir=bin --exclude-dir=obj \
          "Process\.Start.*request\|cmd.*exe.*request\|powershell.*request" .; then
          echo "âŒ Potential command injection vulnerability found!"
          DANGEROUS_PATTERNS=true
        fi
        
        # Path traversal patterns
        if grep -r -i --include="*.cs" --exclude-dir=bin --exclude-dir=obj \
          "Path\.Combine.*request\|File\..*request.*\.\." .; then
          echo "âŒ Potential path traversal vulnerability found!"
          DANGEROUS_PATTERNS=true
        fi
        
        # Deserialization patterns
        if grep -r -i --include="*.cs" --exclude-dir=bin --exclude-dir=obj \
          "JsonConvert\.DeserializeObject.*request\|BinaryFormatter" .; then
          echo "âŒ Potential unsafe deserialization found!"
          DANGEROUS_PATTERNS=true
        fi
        
        if [ "$DANGEROUS_PATTERNS" = true ]; then
          echo "âŒ Dangerous code patterns detected!"
          echo "Please review and implement proper input validation and sanitization."
          exit 1
        else
          echo "âœ… No dangerous code patterns detected"
        fi

  configuration-security-audit:
    name: Configuration Security Audit
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Audit appsettings files
      run: |
        echo "ðŸ” Auditing configuration files for security issues..."
        
        CONFIG_ISSUES=false
        
        # Check all appsettings files
        for config_file in $(find . -name "appsettings*.json" -not -path "./bin/*" -not -path "./obj/*"); do
          echo "Checking $config_file..."
          
          # Check for secrets in config files
          if grep -E "(ApiKey|Password|Secret|Token).*[\"'].[^\"']{10,}" "$config_file"; then
            echo "âŒ Potential secrets found in $config_file"
            CONFIG_ISSUES=true
          fi
          
          # Check for insecure settings
          if grep -i "false" "$config_file" | grep -E "(RequireHttpsMetadata|ValidateIssuer|ValidateAudience)"; then
            echo "âŒ Insecure authentication settings in $config_file"
            CONFIG_ISSUES=true
          fi
          
          # Check for debug settings in production config
          if echo "$config_file" | grep -i "production" && grep -i "true" "$config_file" | grep -i "debug"; then
            echo "âŒ Debug settings enabled in production config: $config_file"
            CONFIG_ISSUES=true
          fi
        done
        
        if [ "$CONFIG_ISSUES" = true ]; then
          echo ""
          echo "âŒ Configuration security issues found!"
          echo "Please review the issues above and fix them."
          exit 1
        else
          echo "âœ… Configuration security audit passed"
        fi

    - name: Check environment variable usage
      run: |
        echo "ðŸ” Checking proper environment variable usage..."
        
        # Check if sensitive data is properly externalized
        REQUIRED_ENV_VARS=(
          "JWT__Key"
          "ConnectionStrings__MongoDbConnection"
          "MailSettings__AppPassword"
          "GoogleMaps__ApiKey"
          "LLMSettings__OpenAI__ApiKey"
          "CloudinarySettings__ApiSecret"
          "Flutterwave__SecretKey"
        )
        
        echo "âœ… Required environment variables for production:"
        for var in "${REQUIRED_ENV_VARS[@]}"; do
          echo "  - $var"
        done
        
        # Verify configuration references environment variables
        if ! grep -r "_configuration\[" --include="*.cs" .; then
          echo "âš ï¸  No configuration references found - ensure environment variables are used"
        else
          echo "âœ… Configuration injection found in code"
        fi

  docker-security-scan:
    name: Docker Security Scan
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/staging'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Create secure Dockerfile for scanning
      run: |
        cat > Dockerfile.security-scan << 'EOF'
        FROM mcr.microsoft.com/dotnet/aspnet:8.0-alpine AS base
        WORKDIR /app
        EXPOSE 5005
        
        # Security: Create non-root user
        RUN addgroup -g 1001 -S appuser && \
            adduser -S appuser -G appuser -u 1001
        
        FROM mcr.microsoft.com/dotnet/sdk:8.0-alpine AS build
        WORKDIR /src
        COPY ["CarePro-Api/CarePro-Api.csproj", "CarePro-Api/"]
        COPY ["Application/Application.csproj", "Application/"]
        COPY ["Domain/Domain.csproj", "Domain/"]
        COPY ["Infrastructure/Infrastructure.csproj", "Infrastructure/"]
        RUN dotnet restore "CarePro-Api/CarePro-Api.csproj"
        COPY . .
        WORKDIR "/src/CarePro-Api"
        RUN dotnet build "CarePro-Api.csproj" -c Release -o /app/build
        
        FROM build AS publish
        RUN dotnet publish "CarePro-Api.csproj" -c Release -o /app/publish /p:UseAppHost=false
        
        FROM base AS final
        WORKDIR /app
        COPY --from=publish /app/publish .
        RUN chown -R appuser:appuser /app
        USER appuser
        ENTRYPOINT ["dotnet", "CarePro-Api.dll"]
        EOF

    - name: Build Docker image for security scan
      run: |
        docker build -f Dockerfile.security-scan -t carepro-security-scan:latest .

    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'carepro-security-scan:latest'
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

    - name: Run Trivy in table format
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'carepro-security-scan:latest'
        format: 'table'
        severity: 'CRITICAL,HIGH'
        exit-code: '1'

  generate-security-report:
    name: Generate Security Report
    runs-on: ubuntu-latest
    needs: [dependency-security-scan, code-security-analysis, configuration-security-audit]
    if: always()
    
    steps:
    - name: Generate security summary
      run: |
        echo "# ðŸ”’ Security Scan Report" > security-report.md
        echo "" >> security-report.md
        echo "**Scan Date:** $(date)" >> security-report.md
        echo "**Repository:** ${{ github.repository }}" >> security-report.md
        echo "**Branch:** ${{ github.ref_name }}" >> security-report.md
        echo "**Commit:** ${{ github.sha }}" >> security-report.md
        echo "" >> security-report.md
        
        echo "## ðŸ“Š Scan Results" >> security-report.md
        echo "" >> security-report.md
        
        if [ "${{ needs.dependency-security-scan.result }}" == "success" ]; then
          echo "âœ… **Dependency Security Scan:** PASSED" >> security-report.md
        else
          echo "âŒ **Dependency Security Scan:** FAILED" >> security-report.md
        fi
        
        if [ "${{ needs.code-security-analysis.result }}" == "success" ]; then
          echo "âœ… **Code Security Analysis:** PASSED" >> security-report.md
        else
          echo "âŒ **Code Security Analysis:** FAILED" >> security-report.md
        fi
        
        if [ "${{ needs.configuration-security-audit.result }}" == "success" ]; then
          echo "âœ… **Configuration Security Audit:** PASSED" >> security-report.md
        else
          echo "âŒ **Configuration Security Audit:** FAILED" >> security-report.md
        fi
        
        echo "" >> security-report.md
        echo "## ðŸ›¡ï¸ Security Recommendations" >> security-report.md
        echo "" >> security-report.md
        echo "1. **Secrets Management:** Use Azure Key Vault, AWS Secrets Manager, or similar" >> security-report.md
        echo "2. **Environment Variables:** Never commit secrets to repository" >> security-report.md
        echo "3. **HTTPS Only:** Ensure all production traffic uses HTTPS" >> security-report.md
        echo "4. **Input Validation:** Implement comprehensive input validation" >> security-report.md
        echo "5. **Regular Updates:** Keep dependencies and base images updated" >> security-report.md
        echo "6. **Authentication:** Use strong authentication and authorization" >> security-report.md
        echo "7. **Logging:** Implement security logging and monitoring" >> security-report.md
        echo "8. **Container Security:** Run containers as non-root users" >> security-report.md
        
        cat security-report.md

    - name: Upload security report
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: security-report-${{ github.sha }}
        path: security-report.md
        retention-days: 90